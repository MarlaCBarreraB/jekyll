#!/usr/bin/env bash
# Runs the `jekyll new` command and builds the default site as a sanity check

set -e

log_label () {
  echo ""
  echo -e "\e[36m$0:\e[0m $1"
}

log_label "setting up tmp directory"
mkdir -p ./tmp
rm -Rf ./tmp/default-site

log_label "creating new default site"
bundle exec jekyll new tmp/default-site
pushd tmp/default-site

log_label "respecifying the jekyll install location"
ruby -e "contents = File.read('Gemfile'); File.write('Gemfile', contents.sub(/gem \"jekyll\".*\\n/, 'gem \"jekyll\", path: \"../../\"'))"
log_label "installing default site dependencies"
BUNDLE_GEMFILE=Gemfile bundle install

log_label "building the default site"
BUNDLE_GEMFILE=Gemfile bundle exec jekyll build --verbose --profile
log_label "building the default site in safe mode"
BUNDLE_GEMFILE=Gemfile bundle exec jekyll build --verbose --profile --safe
popd
