#!/bin/sh
set -e

msg_and_run() {
	printf "%s==> $1 %s\n" $(tput setaf 1) $(tput sgr0)
	shift; "$@"
}

export PROOF=true
export DESTINATION="_site"
export IGNORE_HREFS="/Chrononaut/,/twitter.com/,/nearlyfreespeech.net/,/eduardoboucas.com/"
export NOKOGIRI_USE_SYSTEM_LIBRARIES=true
export SOURCE="site"

status=0
msg_and_run "Installing..." bundle install -j8 --with site
msg_and_run "Building..." bundle exec jekyll build -s "$SOURCE" -d "$DESTINATION" --trace
msg_and_run "Proofing..." time bundle exec htmlproof "./$DESTINATION" --href-ignore="$INGORE_HREFS" || status=$?
msg_and_run "Uninstalling..." bundle install -j8 --without site
msg_and_run "Cleaning..." bundle clean
exit $status
